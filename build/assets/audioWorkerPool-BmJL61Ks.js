class T{workers=[];availableWorkers=[];taskQueue=[];poolSize;pendingTasks=new Map;constructor(){this.poolSize=Math.min(navigator.hardwareConcurrency||2,4),this.initializePool()}initializePool(){console.log("Audio processing will run on main thread (Workers disabled)")}handleWorkerMessage(e,t){const o=this.pendingTasks.get(e);if(!o)return;clearTimeout(o.timeout),this.pendingTasks.delete(e);const{waveform:n,waveformOverview:r,duration:l,error:s}=t.data;s?o.reject(new Error(s)):o.resolve({waveform:n,waveformOverview:r,duration:l}),this.returnWorkerToPool(e)}handleWorkerError(e,t){const o=this.pendingTasks.get(e);o&&(clearTimeout(o.timeout),this.pendingTasks.delete(e),o.reject(t instanceof ErrorEvent?new Error(t.message):new Error("Worker error")),this.returnWorkerToPool(e))}async processAudio(e,t){return this.workers.length===0?this.processAudioMainThread(e,t):new Promise((o,n)=>{const r={file:e,samples:t,resolve:o,reject:n};this.availableWorkers.length>0?this.executeTask(r):this.taskQueue.push(r)})}async processAudioMainThread(e,t=500){const o=await e.arrayBuffer(),n=window.AudioContext||window.webkitAudioContext,r=new n;try{const l=await r.decodeAudioData(o),s=l.getChannelData(0),k=l.duration,f=Math.floor(s.length/t),i=[];for(let u=0;u<t;u++){const h=u*f,w=h+f;let c=0;for(let a=h;a<w&&a<s.length;a++){const d=Math.abs(s[a]);d>c&&(c=d)}i.push(c)}const p=1e3,m=Math.floor(s.length/p),v=[];for(let u=0;u<p;u++){const h=u*m,w=h+m;let c=0;for(let a=h;a<w&&a<s.length;a++){const d=Math.abs(s[a]);d>c&&(c=d)}v.push(c)}return{waveform:i,waveformOverview:v,duration:k}}finally{r.state!=="closed"&&await r.close()}}async executeTask(e){const t=this.availableWorkers.pop();if(t)try{const o=await e.file.arrayBuffer(),n=window.AudioContext||window.webkitAudioContext,r=new n;let l,s;try{const i=await r.decodeAudioData(o);l=i.getChannelData(0),s=i.duration}finally{r.state!=="closed"&&await r.close()}const k=setTimeout(()=>{const i=this.pendingTasks.get(t);i&&(this.pendingTasks.delete(t),i.reject(new Error("Worker timeout (30s)")),this.returnWorkerToPool(t))},3e4);this.pendingTasks.set(t,{resolve:e.resolve,reject:e.reject,timeout:k});const f=new Float32Array(l);t.postMessage({type:"generateWaveform",rawData:f,duration:s,samples:e.samples})}catch(o){e.reject(o),this.returnWorkerToPool(t)}}returnWorkerToPool(e){if(this.availableWorkers.push(e),this.taskQueue.length>0){const t=this.taskQueue.shift();t&&this.executeTask(t)}}terminate(){this.pendingTasks.forEach(e=>{clearTimeout(e.timeout),e.reject(new Error("Worker pool terminated"))}),this.pendingTasks.clear(),this.workers.forEach(e=>e.terminate()),this.workers=[],this.availableWorkers=[],this.taskQueue=[]}getStats(){return{poolSize:this.poolSize,availableWorkers:this.availableWorkers.length,queuedTasks:this.taskQueue.length,busyWorkers:this.poolSize-this.availableWorkers.length}}}let g=null;function x(){return g||(g=new T),g}export{x as getAudioWorkerPool};
