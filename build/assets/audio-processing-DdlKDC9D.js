const x="modulepreload",S=function(e){return"/"+e},b={},C=function(t,o,r){let u=Promise.resolve();if(o&&o.length>0){let a=function(s){return Promise.all(s.map(l=>Promise.resolve(l).then(h=>({status:"fulfilled",value:h}),h=>({status:"rejected",reason:h}))))};document.getElementsByTagName("link");const n=document.querySelector("meta[property=csp-nonce]"),c=n?.nonce||n?.getAttribute("nonce");u=a(o.map(s=>{if(s=S(s),s in b)return;b[s]=!0;const l=s.endsWith(".css"),h=l?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${s}"]${h}`))return;const d=document.createElement("link");if(d.rel=l?"stylesheet":x,l||(d.as="script"),d.crossOrigin="",d.href=s,c&&d.setAttribute("nonce",c),document.head.appendChild(d),l)return new Promise((T,m)=>{d.addEventListener("load",T),d.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${s}`)))})}))}function i(a){const n=new Event("vite:preloadError",{cancelable:!0});if(n.payload=a,window.dispatchEvent(n),!n.defaultPrevented)throw a}return u.then(a=>{for(const n of a||[])n.status==="rejected"&&i(n.reason);return t().catch(i)})};function A(e){return isNaN(e)||!isFinite(e)||e<=0?-1/0:20*Math.log10(e)}function E(e){return!isFinite(e)||e<=-60?0:Math.pow(10,e/20)}function D(e){return e<=0?-1/0:-60+e/100*66}function _(e){return!isFinite(e)||e<=-60?0:(e- -60)/66*100}function B(e){if(isNaN(e)||!isFinite(e))return 1;const t=D(e);return E(t)}function N(e){if(isNaN(e)||!isFinite(e))return _(0);const t=A(e);return _(t)}function j(e){return!isFinite(e)||e<=-60?"-âˆž":e>=0?`+${e.toFixed(1)}`:e.toFixed(1)}async function z(e,t){try{const{getAudioWorkerPool:o}=await C(async()=>{const{getAudioWorkerPool:u}=await Promise.resolve().then(()=>I);return{getAudioWorkerPool:u}},void 0);return await o().processAudio(e,t)}catch{try{const r=await e.arrayBuffer(),i=await new(window.AudioContext||window.webkitAudioContext)().decodeAudioData(r),a=i.getChannelData(0),n=i.duration,c=w=>{const v=Math.max(1,Math.floor(a.length/w)),f=[];for(let k=0;k<w;k++){const y=v*k;let p=0;const M=v>500?10:1;for(let g=0;g<v&&y+g<a.length;g+=M){const W=Math.abs(a[y+g]);W>p&&(p=W)}f.push(p)}return f},l=t||Math.ceil(n*500),h=c(l),d=c(2e4),T=c(2e3),m=w=>{const v=w.reduce((f,k)=>Math.max(f,k),.001);return w.map(f=>f/v)};return{waveform:m(h),waveformMedium:m(d),waveformOverview:m(T),duration:n}}catch(r){return console.error("Critical: Failed to generate waveform on main thread:",r),{waveform:[],waveformMedium:[],waveformOverview:[],duration:0}}}}const L=Object.freeze(Object.defineProperty({__proto__:null,dbToGain:E,dbToSlider:_,formatDb:j,gainToDb:A,gainToSlider:N,generateWaveformFromFile:z,sliderToDb:D,sliderToGain:B},Symbol.toStringTag,{value:"Module"}));class O{workers=[];availableWorkers=[];taskQueue=[];poolSize;pendingTasks=new Map;constructor(){this.poolSize=Math.min(navigator.hardwareConcurrency||2,4),this.initializePool()}initializePool(){console.log("Audio processing will run on main thread (Workers disabled)")}handleWorkerMessage(t,o){const r=this.pendingTasks.get(t);if(!r)return;clearTimeout(r.timeout),this.pendingTasks.delete(t);const{waveform:u,waveformMedium:i,waveformOverview:a,duration:n,error:c}=o.data;c?r.reject(new Error(c)):r.resolve({waveform:u,waveformMedium:i,waveformOverview:a,duration:n}),this.returnWorkerToPool(t)}handleWorkerError(t,o){const r=this.pendingTasks.get(t);r&&(clearTimeout(r.timeout),this.pendingTasks.delete(t),r.reject(o instanceof ErrorEvent?new Error(o.message):new Error("Worker error")),this.returnWorkerToPool(t))}async processAudio(t,o){return this.workers.length===0?this.processAudioMainThread(t,o):new Promise((r,u)=>{const i={file:t,samples:o,resolve:r,reject:u};this.availableWorkers.length>0?this.executeTask(i):this.taskQueue.push(i)})}async processAudioMainThread(t,o=500){const r=await t.arrayBuffer(),u=window.AudioContext||window.webkitAudioContext,i=new u;try{const a=await i.decodeAudioData(r),n=a.getChannelData(0),c=a.duration,s=m=>{const w=Math.floor(n.length/m),v=[];for(let f=0;f<m;f++){const k=f*w,y=k+w;let p=0;for(let M=k;M<y&&M<n.length;M++){const g=Math.abs(n[M]);g>p&&(p=g)}v.push(p)}return v},l=Math.ceil(c*500),h=s(l),d=s(2e4),T=s(2e3);return{waveform:h,waveformMedium:d,waveformOverview:T,duration:c}}finally{i.state!=="closed"&&await i.close()}}async executeTask(t){const o=this.availableWorkers.pop();if(o)try{const r=await t.file.arrayBuffer(),u=window.AudioContext||window.webkitAudioContext,i=new u;let a,n;try{const l=await i.decodeAudioData(r);a=l.getChannelData(0),n=l.duration}finally{i.state!=="closed"&&await i.close()}const c=setTimeout(()=>{const l=this.pendingTasks.get(o);l&&(this.pendingTasks.delete(o),l.reject(new Error("Worker timeout (30s)")),this.returnWorkerToPool(o))},3e4);this.pendingTasks.set(o,{resolve:t.resolve,reject:t.reject,timeout:c});const s=new Float32Array(a);o.postMessage({type:"generateWaveform",rawData:s,duration:n,samples:t.samples})}catch(r){t.reject(r),this.returnWorkerToPool(o)}}returnWorkerToPool(t){if(this.availableWorkers.push(t),this.taskQueue.length>0){const o=this.taskQueue.shift();o&&this.executeTask(o)}}terminate(){this.pendingTasks.forEach(t=>{clearTimeout(t.timeout),t.reject(new Error("Worker pool terminated"))}),this.pendingTasks.clear(),this.workers.forEach(t=>t.terminate()),this.workers=[],this.availableWorkers=[],this.taskQueue=[]}getStats(){return{poolSize:this.poolSize,availableWorkers:this.availableWorkers.length,queuedTasks:this.taskQueue.length,busyWorkers:this.poolSize-this.availableWorkers.length}}}let P=null;function F(){return P||(P=new O),P}const I=Object.freeze(Object.defineProperty({__proto__:null,getAudioWorkerPool:F},Symbol.toStringTag,{value:"Module"}));export{C as _,A as a,D as b,L as c,j as f,N as g,B as s};
